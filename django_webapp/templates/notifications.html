<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Node.JS + Socket.IO + Redis + Python</title>
<link rel="stylesheet"
	href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
<link rel="stylesheet"
	href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">

<!--
/*
 * Copyright (c) 2014 Horacio G. de Oro - hgdeoro@gmail.com
 * MIT License - See LICENSE.txt
 */
-->

</head>
<body>
	<div class="container">

		<em>The Django app is a WIP.</em>

		<form action="" method="post" id="form">
			<textarea class="form-control" rows="3" name="message-text"
				id="message-text"></textarea>
			<input type="submit" id="send-button" class="btn btn-primary"
				value="Send"> <input type="hidden" id="user-id"
				name="user-id" value="">
		</form>

		<h1>User's notifications</h1>
		<div id="messages"></div>

	</div>
	<!-- /container -->

	<!-- ================================================== -->
	<!-- == JavaScripts -->
	<!-- ================================================== -->

	<script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
	<script
		src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script type="text/javascript">
    //
    // Retrieves the uuidCookie using Ajax
    //
    var retrieveUuidCookie = function(socket) {
      return function() {
        addLog('Socket.IO connected');
        console.log('Socket.IO connected');

        $
            .ajax({
              type : "GET",
              url : "/python/uuidCookie/",
            })
            .done(
                function(msg) {
                  if (msg.ok === true) {
                    console.log("UUID-Cookie received from server using AJAX: "
                        + msg.uuidCookie + " - userId: " + msg.userId);

                    // 2. Use that UUID to subscribe to events
                    console.log('uuidCookie: ' + msg.uuidCookie);
                    console.log('userId: ' + msg.userId);
                    $('#user-id').val(msg.userId);
                    addLog('Trying to subscribe to notifications');
                    socket.emit('subscribe-to-notifications', {
                      uuid : msg.uuidCookie
                    });

                  } else {
                    addLog('ERROR: couldn\'t subscribe to notifications');
                    console
                        .log("Error: the server didn't provide a valid UUID-Cookie");
                  }
                });

      }
    };

    var addLog = function(msg) {
      var newMsg = $('<div/>');
      newMsg.addClass("alert alert-info");
      newMsg.text('[LOG] ' + msg);
      newMsg.appendTo('#messages');
    }

    var addMessage = function(msg) {
      var newMsg = $('<div/>');
      newMsg.addClass("alert alert-success");
      newMsg.text('[NOTIFICATION] ' + msg);
      newMsg.appendTo('#messages');
    }

    $(document).ready(function() {

      var postUrl = '/python/postMessage/';

      $("#form").submit(function(event) {
        event.preventDefault();
        var posting = $.post(postUrl, $("#form").serialize());
        posting.done(function(data) {
          $('#message-text').val('');
        });
      });

      var socket = io.connect('/io/user/notifications');

      socket.on('notification', function(data) {
        console.log('Notification received: ' + data);
        console.log(' - Message from app: ' + data.message);
        addMessage(data.message);
      });

      socket.on('internal', function(data) {
        console.log('Internal message received from server: ' + data);
        if (data.type === 'error') {
          addLog('ERROR: couldn\'t subscribe to notifications');
          console.log('Error report received from server: ' + data);
          console.log(' - Code: ' + data.code);
          console.log(' - Message: ' + data.message);
        } else if (data.type === 'success') {
          addLog('Subscription to notifications OK');
          console.log(' - Success: ' + data.message);
        } else {
          console.log('Unknown internal message type');
        }
      });

      socket.on('connect', retrieveUuidCookie(socket));
    });
  </script>
</body>
</html>
